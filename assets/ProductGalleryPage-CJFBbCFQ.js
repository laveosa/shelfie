import{k as q,d as V,S as L,q as Y,G as m,A as H,bw as c,K as u,Y as O,o as B,r as Q,j as I}from"./index-wSBNnuB8.js";import{P as _,C as z}from"./ConnectImageCard-CrEAc6tk.js";import{S as K}from"./SheContextSidebar-BsxFTrZ4.js";import{u as J}from"./useProductsPageService-CwciQf7m.js";import{u as W}from"./useToast-DSTTjhYC.js";import{u as X}from"./useCardActions-B19clblY.js";import"./SheCard-bH-Mmfkw.js";import"./useAppTranslation-B6fVj9SN.js";import"./chevron-up-B-23HzTx.js";import"./SheCardNotification-DNhAQQpN.js";import"./ComponentViewEnum-Ba6F4129.js";import"./SheInput-LNN_iGxg.js";import"./SheGrid-hfSKbVHD.js";import"./SheSelect-XCRVqNk7.js";import"./select-DgEqAAn6.js";import"./settings-2-DSTwlptS.js";import"./SheFileUploader-p37o_Z2V.js";import"./placeholder-image-BgG3Yd5d.js";import"./trash-Dbp6jI_-.js";const Z={};function $(f){const o=q(),s=V(L.PRODUCT_GALLERY),r=V(L.PRODUCTS),d=J(),{openConfirmationDialog:P}=Y(),{addToast:n}=W(),[p]=m.useGetTheProductsForGridMutation(),[C]=H.useUploadPhotoMutation(),[v]=m.usePutPhotoInNewPositionMutation(),[A]=H.useDeletePhotoMutation(),[l]=m.useLazyGetProductVariantsQuery(),[h]=m.useAttachProductPhotoToVariantMutation(),[T]=m.useDetachVariantPhotoMutation(),[x]=H.useSetPhotoActivationStateMutation();function w(t){return o(c.setIsLoading(!0)),p(t).then(e=>{if(o(c.setIsLoading(!1)),!e.error)return e.data})}function k(t,e){return o(c.setIsImageUploaderLoading(!0)),C(t).then(i=>{var a;return i.error?(n({text:((a=i.error.data)==null?void 0:a.detail)||"Upload failed",type:"error"}),i):(i.data.photoId&&(o(c.setIsImageUploaderLoading(!1)),d.getProductPhotosHandler(Number(e)).then(g=>{o(u.refreshProductPhotos(g))}),d.getCountersForProductsHandler(e),n({text:"Photos added successfully",type:"success"})),i)})}function y(t,e){return v({productId:e,photoId:t.activeItem.photoId,index:t.newIndex}).then(()=>{(t.newIndex===0||t.oldIndex===0)&&d.getTheProductsForGridHandler(r.productsGridRequestModel,!0)})}async function D(t,e){if(!await P({headerTitle:"Deleting product photo",text:"You are about to delete product photo.",primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"}))return;o(u.setIsProductPhotosLoading(!0));const a=await A(t.photoId);if(a.error)n({text:"Photo not deleted",description:a.error.message,type:"error"});else{const[g,j,E]=await Promise.all([d.getProductPhotosHandler(Number(e)),d.getCountersForProductsHandler(e),t.id===1?d.getTheProductsForGridHandler(r.productsGridRequestModel,!0):Promise.resolve({items:[]})]);queueMicrotask(()=>{o(u.refreshProductPhotos(g)),o(u.refreshProductCounter(j)),t.id===1&&o(u.refreshProducts(E.items))}),n({text:"Photo deleted successfully",type:"success"})}}function S(t){return l(t).then(e=>(o(c.refreshProductVariants(e.data)),e.data))}function N(t,e){return x({contextName:"Product",contextId:t,photoId:e.photoId,model:{isActive:!e.isActive}}).then(i=>{i.error||o(u.refreshProductPhotos(r.productPhotos.map(a=>a.photoId===e.photoId?{...a,isActive:!e.isActive}:a)))})}function M(t){o(u.refreshProductPhotos(O(t.photoId,r.productPhotos,"photoId"))),o(c.refreshSelectedPhoto(t)),o(c.refreshProductVariants(s.productVariants.map(e=>{var a;const i=(a=t.variants)==null?void 0:a.some(g=>g.variantId===e.variantId);return{...e,isActive:i}}))),f("connectImageCard",!0)}function F(t){t.row.original.isActive?b(t):G(t)}function G(t){return h({variantId:t.row.original.variantId,photoId:s.selectedPhoto.photoId}).then(e=>{if(!e.error){const i=s.productVariants.map(a=>a.variantId===t.row.original.variantId?{...a,isActive:!0}:a);o(c.refreshProductVariants(i))}})}function b(t){return T({id:t.row.original.variantId,photoId:s.selectedPhoto.photoId}).then(e=>{if(!e.error){const i=s.productVariants.map(a=>a.variantId===t.row.original.variantId?{...a,isActive:!1}:a);o(c.refreshProductVariants(i))}})}function R(t){r.products===null&&(o(u.setIsItemsCardLoading(!0)),d.getTheProductsForGridHandler(r.productsGridRequestModel).then(()=>{o(u.setIsItemsCardLoading(!1))})),r.productCounter||(o(u.setIsProductMenuCardLoading(!0)),d.getCountersForProductsHandler(t).then(()=>{o(u.setIsProductMenuCardLoading(!1))})),o(c.setIsProductPhotosCardLoading(!0)),d.getProductPhotosHandler(Number(t)).then(()=>{o(c.setIsProductPhotosCardLoading(!1))}),S(Number(t))}function U(){f("connectImageCard")}return{state:s,productsState:r,productsService:d,getTheProductsForGridHandler:w,uploadPhotoHandler:k,putPhotoInNewPositionHandler:y,deletePhotoHandler:D,openConnectImageCard:M,imageActionsHandler:F,attachImageToVariantHandler:G,detachImageFromVariantHandler:b,getProductVariantsHandler:S,setPhotoActivationStateHandler:N,getProductGalleryPageDataHandler:R,closeConnectImageCardHandler:U}}function Ct(){var C,v,A;const{handleCardAction:f,createRefCallback:o}=X({selectActiveCards:l=>l[L.PRODUCT_GALLERY].activeCards,refreshAction:c.refreshActiveCards}),{state:s,productsState:r,productsService:d,...P}=$(f),{productId:n}=B();Q.useEffect(()=>{P.getProductGalleryPageDataHandler(n)},[n]);async function p(l,h){switch(l){case"itemCardClick":d.itemCardHandler(h);break;case"uploadPhoto":P.uploadPhotoHandler(h,n);break;case"changePhotoPosition":P.putPhotoInNewPositionHandler(h,n);break;case"deletePhoto":P.deletePhotoHandler(h,n);break;case"activatePhoto":P.setPhotoActivationStateHandler(Number(n),h);break;case"openConnectImageCard":P.openConnectImageCard(h);break;case"imageActions":P.imageActionsHandler(h);break;case"closeConnectImageCard":P.closeConnectImageCardHandler();break}}return I.jsx("div",{className:Z.productGalleryPage,children:I.jsxs(K,{menuCollectionType:"products",menuTitle:"Manage Product",isListLoading:r.isItemsCardLoading,listItems:r[r.activeTab],showListItems:!0,selectedId:r.activeTab==="products"?n:(C=r.selectedVariant)==null?void 0:C.variantId,skeletonQuantity:r.activeTab==="products"?(v=r.products)==null?void 0:v.length:(A=r.variants)==null?void 0:A.length,activeTab:r.activeTab,counter:r.productCounter,itemId:Number(n),activeCards:s.activeCards,onAction:l=>p("itemsCardClick",l),children:[I.jsx(_,{isLoading:s.isProductPhotosCardLoading,isImageUploaderLoading:s.isImageUploaderLoading,isGridLoading:r.isProductPhotosLoading,data:r.productPhotos,productCounter:r.productCounter,contextId:n,onAction:p}),s.activeCards.includes("connectImageCard")&&I.jsx("div",{ref:o("connectImageCard"),children:I.jsx(z,{isLoading:s.isConnectImageCardLoading,isGridLoading:s.isVariantsGridLoading,variants:s.productVariants,selectedPhoto:s.selectedPhoto,productCounter:r.productCounter,onAction:p})})]})})}export{Ct as ProductGalleryPage};
