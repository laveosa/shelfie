import{t as ce,z as de,n as H,S as T,B as ue,E as g,G as m,H as x,N as F,j as t,e as y,s as le,o as N,f as me,q as Ce,J as pe,K as he,R as fe,y as ge,r as xe}from"./index-DybU9lv3.js";import{c as De}from"./OrdersPage.module-m8m3mWZe.js";import{u as Se}from"./useToast-D6yqOzuN.js";import{u as je}from"./useOrdersPageService-CceZJp0X.js";import{c as E,C as ye}from"./CustomerCard-LDVdzg4K.js";import{S as M}from"./SheCard-JWlyTss7.js";import{S as b}from"./SheGrid-DvAOS33I.js";import{T as k}from"./SheCardNotification-Yx-BMvzf.js";import{u as P}from"./useAppTranslation-NlALFuCP.js";import{U as ve,b as Ie,S as Le}from"./SheContextSidebar-BKksk-en.js";import{P as _}from"./plus-Dv0aUE5j.js";import{u as Oe}from"./useCardActions-CTfPrRnB.js";import{S as Ne}from"./SelectEntityCard-E8PNnYAH.js";import{C as Te}from"./CustomersListGridColumns-CMMMjvIo.js";import{S as be}from"./SheInput-CKzfybja.js";import{S as _e}from"./SheSelect-DkAtzaWK.js";import{c as ke}from"./she-select-convertors-CdG-Ygpu.js";import"./types-Cs0d5Ub-.js";import"./form-CP3c_0ZX.js";import"./ComponentViewEnum-Ba6F4129.js";import"./settings-2-JTaowDGi.js";import"./chevron-up-C7ChJr01.js";import"./folder-up-Cq6cKtKD.js";import"./trash-CFfYG3xN.js";import"./select-BDB0m4xP.js";function Re(l){const s=ce(),n=de(),{addToast:e}=Se(),a=H(T.ORDER_DETAILS),r=H(T.ORDERS),d=je(),{openConfirmationDialog:D}=ue(),[p]=g.useLazyGetOrderDetailsQuery(),[v]=g.useGetListOfCustomersForGridMutation(),[L]=g.useAssignCustomerToOrderMutation(),[h]=g.useDeleteOrderMutation(),[A]=g.useLazyGetDiscountsListQuery(),[B]=g.useCreateDiscountMutation(),[q]=g.useRemoveDiscountsFromOrderMutation(),[z]=g.useApplyDiscountsToOrderMutation(),[K]=g.useCreateCustomerMutation(),[w]=g.useUpdateCustomerMutation(),[$]=g.useDeleteCustomerMutation();function U(o){return s(m.setIsOrderConfigurationCardLoading(!0)),s(m.setIsDiscountsGridLoading(!0)),s(m.setIsShipmentsGridLoading(!0)),p(o).then(c=>(s(m.setIsOrderConfigurationCardLoading(!1)),s(m.setIsDiscountsGridLoading(!1)),s(m.setIsShipmentsGridLoading(!1)),s(x.refreshSelectedOrder(c.data)),s(x.refreshProductCounter({products:c.data.unitsAmount})),c))}function R(o){return s(m.setIsSelectEntityGridLoading(!0)),v(o).then(c=>(s(m.setIsSelectEntityGridLoading(!1)),s(x.refreshCustomersGridRequestModel(c.data)),c.data))}function W(o,c){return l("selectEntityCard"),s(m.setIsOrderConfigurationCardLoading(!0)),L({orderId:o,customerId:c}).then(i=>(s(m.setIsOrderConfigurationCardLoading(!1)),s(x.refreshSelectedOrder(i.data)),i))}async function V(o){if(await D({headerTitle:"Deleting order",text:"You are about to delete order.",primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"}))return h(o).then(i=>(i.error?e({text:`${i.error.data.detail}`,type:"error"}):(n(`${F.SALES}${F.ORDERS}`),e({text:"Order deleted successfully",type:"success"})),i))}function Q(){return l("selectDiscountCard",!0),s(m.setIsSelectDiscountGridLoading(!0)),A().then(o=>{var C,f,I;s(m.setIsSelectDiscountGridLoading(!1));const c=((f=(C=r.selectedOrder)==null?void 0:C.discounts)==null?void 0:f.map(j=>j.discountId))??[],i=(I=o.data)==null?void 0:I.map(j=>({...j,isSelected:c.includes(j.discountId)}));return s(m.refreshDiscountsList(i)),o.data})}function Y(o,c){return B(c).then(i=>{if(i.error)e({text:`${i.error.data.detail}`,type:"error"});else{const f=[{...i.data,isSelected:!0},...a.discountsList];s(m.refreshDiscountsList(f)),l("selectDiscountCard"),G(o,{discounts:[i.data.discountId]},f),e({text:"Discount created successfully",type:"success"})}return i})}function J(o,c){return q({orderId:o,model:c}).then(i=>{var C,f;if(i.error)e({text:`${i.error.data.detail}`,type:"error"});else{s(x.refreshSelectedOrder(i.data));const I=((C=i.data.discounts)==null?void 0:C.map(S=>S.discountId))??[],j=(f=a.discountsList)==null?void 0:f.map(S=>({...S,isSelected:I.includes(S.discountId)}));s(m.refreshDiscountsList(j)),e({text:"Discount successfully removed from order",type:"success"})}return i})}function G(o,c,i=a.discountsList){return z({orderId:o,model:c}).then(C=>{var f;if(C.error)e({text:`${C.error.data.detail}`,type:"error"});else{s(x.refreshSelectedOrder(C.data));const I=((f=C.data.discounts)==null?void 0:f.map(S=>S.discountId))??[],j=i.map(S=>({...S,isSelected:I.includes(S.discountId)}));s(m.refreshDiscountsList(j)),l("selectDiscountCard"),e({text:"Discount successfully applied to order",type:"success"})}return C})}function X(){l("selectEntityCard",!0),d.getListOfCustomersForGridHandler(r.customersGridRequestModel).then(o=>{const c=o.items.map(i=>({...i,isSelected:i.customerId===r.selectedOrder.customerId}));s(x.refreshCustomersGridRequestModel({...r.customersGridRequestModel,items:c}))})}function Z(o){R({...r.customersGridRequestModel,searchQuery:o})}function ee(){l("selectEntityCard")}function te(){l("selectDiscountCard")}function se(){l("customerCard",!0),s(m.resetSelectedCustomer())}function re(o){l("customerCard",!0),s(m.refreshSelectedCustomer(o));const c=r.customersGridRequestModel.items.map(i=>i.customerId===o.customerId?{...i,isGridItemSelected:!0}:{...i,isGridItemSelected:!1});s(x.refreshCustomersGridRequestModel({...r.customersGridRequestModel,items:c}))}function ae(o){const c=E(o);return s(m.setIsCustomerCardLoading(!0)),K(c).then(i=>{s(m.setIsCustomerCardLoading(!1)),!i.error&&(e({text:"New customer created successfully",type:"info"}),s(m.refreshSelectedCustomer(i.data)),s(x.refreshCustomersGridRequestModel({...r.customersGridRequestModel,items:[...r.customersGridRequestModel.items,i.data]})))})}function ie(o){var i;const c=E(o);return s(m.setIsCustomerCardLoading(!0)),w({id:(i=a.selectedCustomer)==null?void 0:i.customerId,model:c}).then(C=>{if(s(m.setIsCustomerCardLoading(!1)),!C.error)return e({text:"Customer updated successfully",type:"info"}),C.data})}async function ne(o){await D({headerTitle:"Deleting customer",text:`You are about to delete customer ${o.customerName}.`,primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"})&&$(o.id).then(i=>{if(i.error){e({text:"Failed to delete customer",type:"error"});return}else l("customerCard"),e({text:"Customer deleted successfully",type:"info"}),s(x.refreshCustomersGridRequestModel({...r.customersGridRequestModel,items:r.customersGridRequestModel.items.filter(C=>C.customerId!==o.customerId)})),r.selectedOrder.customerId===o.customerId&&s(x.refreshSelectedOrder({...r.selectedOrder,customer:null}))})}function oe(){l("customerCard")}return{state:a,ordersState:r,getOrderDetailsHandler:U,getListOfCustomersForGridHandler:R,assignCustomerToOrderHandler:W,deleteOrderHandler:V,getDiscountsListHandler:Q,createDiscountHandler:Y,removeDiscountsFromOrderHandler:J,applyDiscountsToOrderHandler:G,openSelectEntityCardHandler:X,searchEntityHandler:Z,closeSelectEntityCardHandler:ee,closeSelectDiscountCardHandler:te,openCreateEntityCardHandler:se,manageCustomerHandler:re,createCustomerHandler:ae,updateCustomerHandler:ie,deleteCustomerHandler:ne,closeCustomerCardHandler:oe}}const Ge="_orderConfigurationCard_1j8jl_1",He="_orderConfigurationCardContent_1j8jl_1",Fe="_orderConfigurationCardItem_1j8jl_8",Ee="_customerInfo_1j8jl_16",Me="_customerInfoAvatarBlock_1j8jl_21",Pe="_avatarImage_1j8jl_26",Ae="_avatarInitials_1j8jl_41",Be="_orderDiscountsGridWrapper_1j8jl_54",qe="_gridFooter_1j8jl_58",ze="_gridFooterItems_1j8jl_68",Ke="_gridFooterItem_1j8jl_68",we="_orderSummaryItems_1j8jl_78",$e="_orderSummaryItem_1j8jl_78",u={orderConfigurationCard:Ge,orderConfigurationCardContent:He,orderConfigurationCardItem:Fe,customerInfo:Ee,customerInfoAvatarBlock:Me,avatarImage:Pe,avatarInitials:Ae,orderDiscountsGridWrapper:Be,gridFooter:qe,gridFooterItems:ze,gridFooterItem:Ke,orderSummaryItems:we,orderSummaryItem:$e};function Ue({onAction:l}){return[{id:"discountRate",header:"Applied Discount rate",minSize:150,cell:({row:s})=>t.jsx("div",{onClick:n=>n.stopPropagation(),children:t.jsx("span",{className:"she-title",children:s.original.discountRate})})},{id:"remove",header:"Actions",minSize:120,maxSize:120,cell:({row:s,table:n})=>{const e=n.options.meta;return t.jsx("div",{onClick:a=>a.stopPropagation(),children:t.jsx(y,{icon:k,value:"Remove",variant:"secondary",onClick:()=>l("removeDiscount",s.original),disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function We({onAction:l}){return[{id:"shipmentRate",header:"Shipment Rate",size:150,minSize:150,maxSize:150,cell:({row:s})=>t.jsx("div",{onClick:n=>n.stopPropagation(),children:t.jsx("span",{className:"she-title",children:s.getValue("shipmentRate")})})},{id:"manage",header:"Actions",minSize:100,maxSize:100,cell:({row:s,table:n})=>{const e=n.options.meta;return t.jsx("div",{onClick:a=>a.stopPropagation(),children:t.jsx(y,{icon:k,value:"Remove",variant:"secondary",onClick:()=>l("removeShipment",s.original),disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function Ve({isLoading:l,isDiscountsGridLoading:s,isShipmentsGridLoading:n,order:e,shipmentsRate:a,onAction:r}){var D,p,v;const{translate:d}=P();return t.jsx(M,{className:u.orderConfigurationCard,title:d("CardTitles.OrderConfiguration",{orderId:e==null?void 0:e.id}),showNotificationCard:!0,isLoading:l,notificationCardProps:{title:"Cancel Order",titleTransKey:"CardTitles.CancelOrder",text:"The order will be cancelled and the stock allocated will be made available for purchase",textTransKey:"ConfirmationMessages.CancelOrder",onClick:()=>r("deleteOrder",e.id)},children:t.jsxs("div",{className:u.orderConfigurationCardContent,children:[t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.CreatedAt")}),t.jsx("span",{className:"she-text",children:le(e==null?void 0:e.date,"date")})]}),t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.PaymentStatus")}),t.jsx("span",{className:"she-text",children:e==null?void 0:e.paymentStatus})]}),t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.ShipmentStatus")}),t.jsx("span",{className:"she-text",children:e==null?void 0:e.shipmentStatus})]}),t.jsx(N,{}),t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:d("SectionTitles.Customer")}),t.jsx(y,{value:e!=null&&e.customer?"Change Customer":"Select Customer",valueTransKey:e!=null&&e.customer?"SpecialText.ChangeCustomer":"OrderActions.SelectCustomer",icon:e!=null&&e.customer?ve:Ie,variant:"secondary",onClick:()=>r("openSelectEntityCard")})]}),(e==null?void 0:e.customer)&&t.jsxs("div",{className:u.customerInfo,children:[t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("CustomerForm.Labels.Name")}),t.jsxs("div",{className:u.customerInfoAvatarBlock,children:[e!=null&&e.customer.thumbnailUrl?t.jsx(me,{className:u.avatarImage,icon:e==null?void 0:e.customer.thumbnailUrl}):t.jsx("div",{className:u.avatarInitials,children:Ce(e==null?void 0:e.customer.customerName)}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.customerName})]})]}),(e==null?void 0:e.customer.email)&&t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("CustomerForm.Labels.Email")}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.email})]}),(e==null?void 0:e.customer.phone)&&t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:d("CustomerForm.Labels.PhoneNumber")}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.phone})]})]}),t.jsx(N,{}),t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:d("SectionTitles.Discount")}),t.jsx(y,{value:"Apply Discount",valueTransKey:"OrderActions.ApplyDiscount",icon:_,variant:"secondary",onClick:()=>r("openSelectDiscountCard")})]}),t.jsxs("div",{className:u.orderDiscountsGridWrapper,children:[t.jsx(b,{className:u.orderDiscountsGrid,isLoading:s,showHeader:!1,columns:Ue({onAction:r}),data:e==null?void 0:e.discounts,customMessage:"There are no discounts applied",customMessageTransKey:"OrderMessages.NoDiscountsApplied"}),t.jsx("div",{className:u.gridFooter,children:t.jsxs("div",{className:u.gridFooterItems,children:[t.jsx("span",{className:u.gridFooterItem,children:d("OrderForm.Labels.DiscountTotal")}),t.jsx("span",{className:u.gridFooterItem,children:e==null?void 0:e.discountAmount})]})})]}),t.jsx(N,{}),t.jsxs("div",{className:u.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:d("SectionTitles.Shipment")}),t.jsx(y,{value:"Set Shipment Rate",valueTransKey:"OrderActions.SetShipmentRate",icon:_,variant:"secondary"})]}),t.jsx(b,{isLoading:n,columns:We({onAction:r}),showHeader:!1,data:a,customMessage:"Shipment rate is not set yet",customMessageTransKey:"OrderMessages.ShipmentRateNotSet"}),t.jsx("span",{className:"she-title",children:d("SectionTitles.Summary")}),t.jsxs("div",{className:u.orderSummaryItems,children:[t.jsxs("div",{className:u.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.ProductsSubtotal")}),t.jsx("span",{className:"she-text",children:(D=e==null?void 0:e.orderSubTotal)==null?void 0:D.subtotal})]}),t.jsxs("div",{className:u.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.TotalWithDiscountAndShipment")}),t.jsx("span",{className:"she-text",children:(p=e==null?void 0:e.orderSubTotal)==null?void 0:p.totalWithDiscountAndShipment})]}),t.jsxs("div",{className:u.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:d("OrderForm.Labels.Profit")}),t.jsx("span",{className:"she-text",children:(v=e==null?void 0:e.orderSubTotal)==null?void 0:v.profit})]})]}),t.jsx(N,{})]})})}const Qe="_selectDiscountCard_d0s2g_1",Ye="_selectDiscountCardContent_d0s2g_1",Je="_selectDiscountText_d0s2g_6",Xe="_createDiscountBlock_d0s2g_9",Ze="_inputBlock_d0s2g_15",O={selectDiscountCard:Qe,selectDiscountCardContent:Ye,selectDiscountText:Je,createDiscountBlock:Xe,inputBlock:Ze},et="_iconCheck_1wa1s_1",tt={iconCheck:et};function st({onAction:l}){return[{id:"select",header:"",minSize:70,maxSize:70,cell:({row:s,table:n})=>{const e=n.options.meta,a=r=>{r.stopPropagation(),r.preventDefault(),l("applyDiscountToOrder",s.original)};return t.jsx("div",{onClick:r=>r.stopPropagation(),children:t.jsx(y,{className:s.original.isSelected===!0?tt.iconCheck:"",icon:s.original.isSelected===!0?pe:he,variant:"ghost",onClick:a,disabled:e==null?void 0:e.isRowLoading(s.id)})})}},{id:"discountRate",header:"Discount Rate",minSize:150,cell:({row:s})=>t.jsx("span",{children:s.original.discountRate})},{id:"remove",header:"Actions",minSize:120,maxSize:120,cell:({row:s,table:n})=>{const e=n.options.meta,a=r=>{r.stopPropagation(),r.preventDefault(),l("removeDiscount",s.original)};return t.jsx("div",{onClick:r=>r.stopPropagation(),children:t.jsx(y,{icon:k,value:"Remove",variant:"secondary",onClick:a,disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function rt({isLoading:l,isGridLoading:s,discounts:n,onAction:e}){const[a,r]=fe.useState(null),{translate:d}=P(),D=[{discountType:"Percentage"},{discountType:"Amount"}];return t.jsx(M,{className:O.selectDiscountCard,title:"Select Discount",titleTransKey:"CardTitles.SelectDiscount",isLoading:l,showCloseButton:!0,onSecondaryButtonClick:()=>e("closeSelectDiscountCard"),children:t.jsxs("div",{className:O.selectDiscountCardContent,children:[t.jsx("span",{className:`${O.selectDiscountText} she-text`,children:d("DiscountForm.Labels.SelectDiscountDescription")}),t.jsxs("div",{className:O.createDiscountBlock,children:[t.jsxs("div",{className:O.inputBlock,children:[t.jsx(be,{label:"Discount Rate",labelTransKey:"DiscountForm.Labels.DiscountRate",placeholder:"Discount rate",placeholderTransKey:"DiscountForm.Placeholders.DiscountRate",onDelay:p=>r({...a,discountRate:Number(p).toFixed(2)})}),t.jsx(_e,{label:"Discount Type",labelTransKey:"DiscountForm.Labels.DiscountType",placeholder:"select discount type...",placeholderTransKey:"DiscountForm.Placeholders.SelectDiscountType",hideFirstOption:!0,selected:a==null?void 0:a.discountType,items:ke(D,{value:"discountType",text:"discountType"}),onSelect:p=>r({...a,discountType:p})})]}),t.jsx(y,{value:"Create and Apply",valueTransKey:"DiscountActions.CreateAndApply",icon:_,variant:"secondary",maxWidth:"165px",onClick:()=>e("createDiscount",a)})]}),t.jsx(b,{isLoading:s,showHeader:!1,columns:st({onAction:e}),data:n,skeletonQuantity:10,customMessage:"There are no discounts created yet",customMessageTransKey:"DiscountMessages.NoDiscountsCreated"})]})})}function bt(){var D,p,v;const{handleCardAction:l,createRefCallback:s}=Oe({selectActiveCards:L=>L[T.ORDER_DETAILS].activeCards,refreshAction:m.refreshActiveCards}),{state:n,ordersState:e,...a}=Re(l),{orderId:r}=ge();xe.useEffect(()=>{(!e.selectedOrder||e.selectedOrder.id!==r)&&a.getOrderDetailsHandler(Number(r))},[r]);async function d(L,h){switch(L){case"openSelectEntityCard":a.openSelectEntityCardHandler();break;case"openCreateEntityCard":a.openCreateEntityCardHandler();break;case"searchEntity":a.searchEntityHandler(h);break;case"selectCustomer":a.assignCustomerToOrderHandler(r,h.customerId);break;case"deleteOrder":a.deleteOrderHandler(Number(r));break;case"createDiscount":a.createDiscountHandler(r,h);break;case"applyDiscountToOrder":a.applyDiscountsToOrderHandler(r,{discounts:[h.discountId]});break;case"removeDiscount":a.removeDiscountsFromOrderHandler(r,{discounts:[h.discountId]});break;case"closeSelectEntityCard":a.closeSelectEntityCardHandler();break;case"openSelectDiscountCard":a.getDiscountsListHandler();break;case"closeSelectDiscountCard":a.closeSelectDiscountCardHandler();break;case"manageCustomer":a.manageCustomerHandler(h);break;case"createCustomer":a.createCustomerHandler(h);break;case"updateCustomer":a.updateCustomerHandler(h);break;case"deleteCustomer":a.deleteCustomerHandler(h);break;case"closeCustomerCard":a.closeCustomerCardHandler();break}}return t.jsx("div",{className:De.ordersPage,children:t.jsxs(Le,{menuCollectionType:"order",menuTitle:"Order",itemId:Number(r),counter:e.productCounter,activeCards:n.activeCards,children:[t.jsx(Ve,{isLoading:n.isOrderConfigurationCardLoading,isDiscountsGridLoading:n.isDiscountsGridLoading,isShipmentsGridLoading:n.isShipmentsGridLoading,order:e.selectedOrder,onAction:d}),((D=n.activeCards)==null?void 0:D.includes("selectEntityCard"))&&t.jsx("div",{ref:s("selectEntityCard"),children:t.jsx(Ne,{isLoading:n.isSelectEntityCardLoading,isGridLoading:n.isSelectEntityGridLoading,entityName:"Customer",entityCollection:e.customersGridRequestModel.items,columns:Te({onAction:d}),onAction:d})}),((p=n.activeCards)==null?void 0:p.includes("customerCard"))&&t.jsx("div",{ref:s("customerCard"),children:t.jsx(ye,{isLoading:n.isCustomerCardLoading,showCloseButton:!0,customer:n.selectedCustomer,onAction:d})}),((v=n.activeCards)==null?void 0:v.includes("selectDiscountCard"))&&t.jsx("div",{ref:s("selectDiscountCard"),children:t.jsx(rt,{isLoading:n.isSelectDiscountCardLoading,isGridLoading:n.isSelectDiscountGridLoading,discounts:n.discountsList,onAction:d})})]})})}export{bt as OrderDetailsPage};
