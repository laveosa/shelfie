import{t as ue,z as le,n as F,S as b,B as me,E as x,G as m,H as S,N as H,j as t,e as I,s as Ce,o as N,q as pe,I as he,J as fe,R as ge,y as xe,r as Se}from"./index-nY2QEa15.js";import{c as De}from"./OrdersPage.module-m8m3mWZe.js";import{u as ve}from"./useToast-C0Zq5D0u.js";import{u as ye}from"./useOrdersPageService-BRdeZHQx.js";import{c as E,C as Ie}from"./CustomerCard-DxW_j6h4.js";import{S as M}from"./SheSelect-Dj8ONBM5.js";import{S as P}from"./SheCard-DogZVG5K.js";import{S as T}from"./SheGrid-H1pV-ZPE.js";import{T as k}from"./SheCardNotification-BOboksNb.js";import{c as A}from"./she-select-convertors-CdG-Ygpu.js";import{u as B}from"./useAppTranslation-U95Zo56s.js";import{U as je,b as Le,S as Oe}from"./SheContextSidebar-C9XHDPKZ.js";import{P as _}from"./plus-gDfo8HrU.js";import{u as Ne}from"./useCardActions-C7GQ_bIM.js";import{S as be}from"./SelectEntityCard-BnLiclcn.js";import{C as Te}from"./CustomersListGridColumns-D5M13F8Z.js";import{S as _e}from"./SheInput-DACYsg9p.js";import"./types-Cye8Ba1V.js";import"./form-rR3P5XEK.js";import"./ComponentViewEnum-Ba6F4129.js";import"./select-0KlKFAp0.js";import"./chevron-up-CNFSe4zU.js";import"./settings-2-B-VDw1D0.js";import"./folder-up-Cj3KmWUi.js";import"./trash-BNRtZ8ux.js";function ke(u){const s=ue(),n=le(),{addToast:e}=ve(),r=F(b.ORDER_DETAILS),a=F(b.ORDERS),p=ye(),{openConfirmationDialog:l}=me(),[f]=x.useLazyGetOrderDetailsQuery(),[j]=x.useGetListOfCustomersForGridMutation(),[v]=x.useAssignCustomerToOrderMutation(),[h]=x.useDeleteOrderMutation(),[q]=x.useLazyGetDiscountsListQuery(),[z]=x.useCreateDiscountMutation(),[K]=x.useRemoveDiscountsFromOrderMutation(),[w]=x.useApplyDiscountsToOrderMutation(),[$]=x.useCreateCustomerMutation(),[W]=x.useUpdateCustomerMutation(),[U]=x.useDeleteCustomerMutation();function V(o){return s(m.setIsOrderConfigurationCardLoading(!0)),s(m.setIsDiscountsGridLoading(!0)),s(m.setIsShipmentsGridLoading(!0)),f(o).then(c=>(s(m.setIsOrderConfigurationCardLoading(!1)),s(m.setIsDiscountsGridLoading(!1)),s(m.setIsShipmentsGridLoading(!1)),s(S.refreshSelectedOrder(c.data)),s(S.refreshProductCounter({products:c.data.unitsAmount})),c))}function R(o){return s(m.setIsSelectEntityGridLoading(!0)),j(o).then(c=>(s(m.setIsSelectEntityGridLoading(!1)),s(S.refreshCustomersGridRequestModel(c.data)),c.data))}function Q(o,c){return u("selectEntityCard"),s(m.setIsOrderConfigurationCardLoading(!0)),v({orderId:o,customerId:c}).then(i=>(s(m.setIsOrderConfigurationCardLoading(!1)),s(S.refreshSelectedOrder(i.data)),i))}async function Y(o){if(await l({headerTitle:"Deleting order",text:"You are about to delete order.",primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"}))return h(o).then(i=>(i.error?e({text:`${i.error.data.detail}`,type:"error"}):(n(`${H.SALES}${H.ORDERS}`),e({text:"Order deleted successfully",type:"success"})),i))}function J(){return u("selectDiscountCard",!0),s(m.setIsSelectDiscountGridLoading(!0)),q().then(o=>{var C,g,L;s(m.setIsSelectDiscountGridLoading(!1));const c=((g=(C=a.selectedOrder)==null?void 0:C.discounts)==null?void 0:g.map(y=>y.discountId))??[],i=(L=o.data)==null?void 0:L.map(y=>({...y,isSelected:c.includes(y.discountId)}));return s(m.refreshDiscountsList(i)),o.data})}function X(o,c){return z(c).then(i=>{if(i.error)e({text:`${i.error.data.detail}`,type:"error"});else{const g=[{...i.data,isSelected:!0},...r.discountsList];s(m.refreshDiscountsList(g)),u("selectDiscountCard"),G(o,{discounts:[i.data.discountId]},g),e({text:"Discount created successfully",type:"success"})}return i})}function Z(o,c){return K({orderId:o,model:c}).then(i=>{var C,g;if(i.error)e({text:`${i.error.data.detail}`,type:"error"});else{s(S.refreshSelectedOrder(i.data));const L=((C=i.data.discounts)==null?void 0:C.map(D=>D.discountId))??[],y=(g=r.discountsList)==null?void 0:g.map(D=>({...D,isSelected:L.includes(D.discountId)}));s(m.refreshDiscountsList(y)),e({text:"Discount successfully removed from order",type:"success"})}return i})}function G(o,c,i=r.discountsList){return w({orderId:o,model:c}).then(C=>{var g;if(C.error)e({text:`${C.error.data.detail}`,type:"error"});else{s(S.refreshSelectedOrder(C.data));const L=((g=C.data.discounts)==null?void 0:g.map(D=>D.discountId))??[],y=i.map(D=>({...D,isSelected:L.includes(D.discountId)}));s(m.refreshDiscountsList(y)),u("selectDiscountCard"),e({text:"Discount successfully applied to order",type:"success"})}return C})}function ee(){u("selectEntityCard",!0),p.getListOfCustomersForGridHandler(a.customersGridRequestModel).then(o=>{const c=o.items.map(i=>({...i,isSelected:i.customerId===a.selectedOrder.customerId}));s(S.refreshCustomersGridRequestModel({...a.customersGridRequestModel,items:c}))})}function te(o){R({...a.customersGridRequestModel,searchQuery:o})}function se(){u("selectEntityCard")}function re(){u("selectDiscountCard")}function ae(){u("customerCard",!0),s(m.resetSelectedCustomer())}function ie(o){u("customerCard",!0),s(m.refreshSelectedCustomer(o));const c=a.customersGridRequestModel.items.map(i=>i.customerId===o.customerId?{...i,isGridItemSelected:!0}:{...i,isGridItemSelected:!1});s(S.refreshCustomersGridRequestModel({...a.customersGridRequestModel,items:c}))}function ne(o){const c=E(o);return s(m.setIsCustomerCardLoading(!0)),$(c).then(i=>{s(m.setIsCustomerCardLoading(!1)),!i.error&&(e({text:"New customer created successfully",type:"info"}),s(m.refreshSelectedCustomer(i.data)),s(S.refreshCustomersGridRequestModel({...a.customersGridRequestModel,items:[...a.customersGridRequestModel.items,i.data]})))})}function oe(o){var i;const c=E(o);return s(m.setIsCustomerCardLoading(!0)),W({id:(i=r.selectedCustomer)==null?void 0:i.customerId,model:c}).then(C=>{if(s(m.setIsCustomerCardLoading(!1)),!C.error)return e({text:"Customer updated successfully",type:"info"}),C.data})}async function ce(o){await l({headerTitle:"Deleting customer",text:`You are about to delete customer ${o.customerName}.`,primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"})&&U(o.id).then(i=>{if(i.error){e({text:"Failed to delete customer",type:"error"});return}else u("customerCard"),e({text:"Customer deleted successfully",type:"info"}),s(S.refreshCustomersGridRequestModel({...a.customersGridRequestModel,items:a.customersGridRequestModel.items.filter(C=>C.customerId!==o.customerId)})),a.selectedOrder.customerId===o.customerId&&s(S.refreshSelectedOrder({...a.selectedOrder,customer:null}))})}function de(){u("customerCard")}return{state:r,ordersState:a,getOrderDetailsHandler:V,getListOfCustomersForGridHandler:R,assignCustomerToOrderHandler:Q,deleteOrderHandler:Y,getDiscountsListHandler:J,createDiscountHandler:X,removeDiscountsFromOrderHandler:Z,applyDiscountsToOrderHandler:G,openSelectEntityCardHandler:ee,searchEntityHandler:te,closeSelectEntityCardHandler:se,closeSelectDiscountCardHandler:re,openCreateEntityCardHandler:ae,manageCustomerHandler:ie,createCustomerHandler:ne,updateCustomerHandler:oe,deleteCustomerHandler:ce,closeCustomerCardHandler:de}}const Re="_orderConfigurationCard_19bvs_1",Ge="_orderConfigurationCardContent_19bvs_1",Fe="_orderConfigurationCardItem_19bvs_8",He="_customerInfo_19bvs_16",Ee="_customerInfoAvatarBlock_19bvs_21",Me="_avatarImage_19bvs_26",Pe="_avatarInitials_19bvs_29",Ae="_orderDiscountsGridWrapper_19bvs_42",Be="_gridFooter_19bvs_46",qe="_gridFooterItems_19bvs_56",ze="_gridFooterItem_19bvs_56",Ke="_orderSummaryItems_19bvs_66",we="_orderSummaryItem_19bvs_66",d={orderConfigurationCard:Re,orderConfigurationCardContent:Ge,orderConfigurationCardItem:Fe,customerInfo:He,customerInfoAvatarBlock:Ee,avatarImage:Me,avatarInitials:Pe,orderDiscountsGridWrapper:Ae,gridFooter:Be,gridFooterItems:qe,gridFooterItem:ze,orderSummaryItems:Ke,orderSummaryItem:we};function $e({onAction:u}){return[{id:"discountRate",header:"Applied Discount rate",minSize:150,cell:({row:s})=>t.jsx("div",{onClick:n=>n.stopPropagation(),children:t.jsx("span",{className:"she-title",children:s.original.discountRate})})},{id:"remove",header:"Actions",minSize:120,maxSize:120,cell:({row:s,table:n})=>{const e=n.options.meta;return t.jsx("div",{onClick:r=>r.stopPropagation(),children:t.jsx(I,{icon:k,value:"Remove",variant:"secondary",onClick:()=>u("removeDiscount",s.original),disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function We({onAction:u}){return[{id:"shipmentRate",header:"Shipment Rate",size:150,minSize:150,maxSize:150,cell:({row:s})=>t.jsx("div",{onClick:n=>n.stopPropagation(),children:t.jsx("span",{className:"she-title",children:s.getValue("shipmentRate")})})},{id:"manage",header:"Actions",minSize:100,maxSize:100,cell:({row:s,table:n})=>{const e=n.options.meta;return t.jsx("div",{onClick:r=>r.stopPropagation(),children:t.jsx(I,{icon:k,value:"Remove",variant:"secondary",onClick:()=>u("removeShipment",s.original),disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function Ue({isLoading:u,isDiscountsGridLoading:s,isShipmentsGridLoading:n,order:e,shipmentsRate:r,statuses:a,onAction:p}){var f,j,v;const{translate:l}=B();return t.jsx(P,{className:d.orderConfigurationCard,title:l("CardTitles.OrderConfiguration",{orderId:e==null?void 0:e.id}),showNotificationCard:!0,isLoading:u,notificationCardProps:{title:"Cancel Order",titleTransKey:"CardTitles.CancelOrder",text:"The order will be cancelled and the stock allocated will be made available for purchase",textTransKey:"ConfirmationMessages.CancelOrder",onClick:()=>p("deleteOrder",e.id)},children:t.jsxs("div",{className:d.orderConfigurationCardContent,children:[t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.CreatedAt")}),t.jsx("span",{className:"she-text",children:Ce(e==null?void 0:e.date,"date")})]}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.OrderStatus")}),t.jsx(M,{selected:(e==null?void 0:e.orderStatus)||null,items:A(a,{text:"statusName",value:"id"}),hideFirstOption:!0,minWidth:"170px",maxWidth:"170px",onSelect:h=>{p("updateOrder",{orderStatus:h})}})]}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.PaymentStatus")}),t.jsx("span",{className:"she-text",children:e==null?void 0:e.paymentStatus})]}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.ShipmentStatus")}),t.jsx("span",{className:"she-text",children:e==null?void 0:e.shipmentStatus})]}),t.jsx(N,{}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:l("SectionTitles.Customer")}),t.jsx(I,{value:e!=null&&e.customer?"Change Customer":"Select Customer",valueTransKey:e!=null&&e.customer?"SpecialText.ChangeCustomer":"OrderActions.SelectCustomer",icon:e!=null&&e.customer?je:Le,variant:"secondary",onClick:()=>p("openSelectEntityCard")})]}),(e==null?void 0:e.customer)&&t.jsxs("div",{className:d.customerInfo,children:[t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("CustomerForm.Labels.Name")}),t.jsxs("div",{className:d.customerInfoAvatarBlock,children:[e!=null&&e.customer.thumbnailUrl?t.jsx("img",{src:e==null?void 0:e.customer.thumbnailUrl,alt:e==null?void 0:e.customer.customerName,className:d.avatarImage}):t.jsx("div",{className:d.avatarInitials,children:pe(e==null?void 0:e.customer.customerName)}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.customerName})]})]}),(e==null?void 0:e.customer.email)&&t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("CustomerForm.Labels.Email")}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.email})]}),(e==null?void 0:e.customer.phone)&&t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-text",children:l("CustomerForm.Labels.PhoneNumber")}),t.jsx("span",{className:"she-subtext",children:e==null?void 0:e.customer.phone})]})]}),t.jsx(N,{}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:l("SectionTitles.Discount")}),t.jsx(I,{value:"Apply Discount",valueTransKey:"OrderActions.ApplyDiscount",icon:_,variant:"secondary",onClick:()=>p("openSelectDiscountCard")})]}),t.jsxs("div",{className:d.orderDiscountsGridWrapper,children:[t.jsx(T,{className:d.orderDiscountsGrid,isLoading:s,showHeader:!1,columns:$e({onAction:p}),data:e==null?void 0:e.discounts,customMessage:"There are no discounts applied",customMessageTransKey:"OrderMessages.NoDiscountsApplied"}),t.jsx("div",{className:d.gridFooter,children:t.jsxs("div",{className:d.gridFooterItems,children:[t.jsx("span",{className:d.gridFooterItem,children:l("OrderForm.Labels.DiscountTotal")}),t.jsx("span",{className:d.gridFooterItem,children:e==null?void 0:e.discountAmount})]})})]}),t.jsx(N,{}),t.jsxs("div",{className:d.orderConfigurationCardItem,children:[t.jsx("span",{className:"she-title",children:l("SectionTitles.Shipment")}),t.jsx(I,{value:"Set Shipment Rate",valueTransKey:"OrderActions.SetShipmentRate",icon:_,variant:"secondary"})]}),t.jsx(T,{isLoading:n,columns:We({onAction:p}),showHeader:!1,data:r,customMessage:"Shipment rate is not set yet",customMessageTransKey:"OrderMessages.ShipmentRateNotSet"}),t.jsx("span",{className:"she-title",children:l("SectionTitles.Summary")}),t.jsxs("div",{className:d.orderSummaryItems,children:[t.jsxs("div",{className:d.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.ProductsSubtotal")}),t.jsx("span",{className:"she-text",children:(f=e==null?void 0:e.orderSubTotal)==null?void 0:f.subtotal})]}),t.jsxs("div",{className:d.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.TotalWithDiscountAndShipment")}),t.jsx("span",{className:"she-text",children:(j=e==null?void 0:e.orderSubTotal)==null?void 0:j.totalWithDiscountAndShipment})]}),t.jsxs("div",{className:d.orderSummaryItem,children:[t.jsx("span",{className:"she-text",children:l("OrderForm.Labels.Profit")}),t.jsx("span",{className:"she-text",children:(v=e==null?void 0:e.orderSubTotal)==null?void 0:v.profit})]})]}),t.jsx(N,{})]})})}const Ve="_selectDiscountCard_d0s2g_1",Qe="_selectDiscountCardContent_d0s2g_1",Ye="_selectDiscountText_d0s2g_6",Je="_createDiscountBlock_d0s2g_9",Xe="_inputBlock_d0s2g_15",O={selectDiscountCard:Ve,selectDiscountCardContent:Qe,selectDiscountText:Ye,createDiscountBlock:Je,inputBlock:Xe},Ze="_iconCheck_1wa1s_1",et={iconCheck:Ze};function tt({onAction:u}){return[{id:"select",header:"",minSize:70,maxSize:70,cell:({row:s,table:n})=>{const e=n.options.meta,r=a=>{a.stopPropagation(),a.preventDefault(),u("applyDiscountToOrder",s.original)};return t.jsx("div",{onClick:a=>a.stopPropagation(),children:t.jsx(I,{className:s.original.isSelected===!0?et.iconCheck:"",icon:s.original.isSelected===!0?he:fe,variant:"ghost",onClick:r,disabled:e==null?void 0:e.isRowLoading(s.id)})})}},{id:"discountRate",header:"Discount Rate",minSize:150,cell:({row:s})=>t.jsx("span",{children:s.original.discountRate})},{id:"remove",header:"Actions",minSize:120,maxSize:120,cell:({row:s,table:n})=>{const e=n.options.meta,r=a=>{a.stopPropagation(),a.preventDefault(),u("removeDiscount",s.original)};return t.jsx("div",{onClick:a=>a.stopPropagation(),children:t.jsx(I,{icon:k,value:"Remove",variant:"secondary",onClick:r,disabled:e==null?void 0:e.isRowLoading(s.id)})})}}]}function st({isLoading:u,isGridLoading:s,discounts:n,onAction:e}){const[r,a]=ge.useState(null),{translate:p}=B(),l=[{discountType:"Percentage"},{discountType:"Amount"}];return t.jsx(P,{className:O.selectDiscountCard,title:"Select Discount",titleTransKey:"CardTitles.SelectDiscount",isLoading:u,showCloseButton:!0,onSecondaryButtonClick:()=>e("closeSelectDiscountCard"),children:t.jsxs("div",{className:O.selectDiscountCardContent,children:[t.jsx("span",{className:`${O.selectDiscountText} she-text`,children:p("DiscountForm.Labels.SelectDiscountDescription")}),t.jsxs("div",{className:O.createDiscountBlock,children:[t.jsxs("div",{className:O.inputBlock,children:[t.jsx(_e,{label:"Discount Rate",labelTransKey:"DiscountForm.Labels.DiscountRate",placeholder:"Discount rate",placeholderTransKey:"DiscountForm.Placeholders.DiscountRate",onDelay:f=>a({...r,discountRate:Number(f).toFixed(2)})}),t.jsx(M,{label:"Discount Type",labelTransKey:"DiscountForm.Labels.DiscountType",placeholder:"select discount type...",placeholderTransKey:"DiscountForm.Placeholders.SelectDiscountType",hideFirstOption:!0,selected:r==null?void 0:r.discountType,items:A(l,{value:"discountType",text:"discountType"}),onSelect:f=>a({...r,discountType:f})})]}),t.jsx(I,{value:"Create and Apply",valueTransKey:"DiscountActions.CreateAndApply",icon:_,variant:"secondary",maxWidth:"165px",onClick:()=>e("createDiscount",r)})]}),t.jsx(T,{isLoading:s,showHeader:!1,columns:tt({onAction:e}),data:n,skeletonQuantity:10,customMessage:"There are no discounts created yet",customMessageTransKey:"DiscountMessages.NoDiscountsCreated"})]})})}function bt(){var l,f,j;const{handleCardAction:u,createRefCallback:s}=Ne({selectActiveCards:v=>v[b.ORDER_DETAILS].activeCards,refreshAction:m.refreshActiveCards}),{state:n,ordersState:e,...r}=ke(u),{orderId:a}=xe();Se.useEffect(()=>{(!e.selectedOrder||e.selectedOrder.id!==a)&&r.getOrderDetailsHandler(Number(a))},[a]);async function p(v,h){switch(v){case"openSelectEntityCard":r.openSelectEntityCardHandler();break;case"openCreateEntityCard":r.openCreateEntityCardHandler();break;case"searchEntity":r.searchEntityHandler(h);break;case"selectCustomer":r.assignCustomerToOrderHandler(a,h.customerId);break;case"deleteOrder":r.deleteOrderHandler(Number(a));break;case"createDiscount":r.createDiscountHandler(a,h);break;case"applyDiscountToOrder":r.applyDiscountsToOrderHandler(a,{discounts:[h.discountId]});break;case"removeDiscount":r.removeDiscountsFromOrderHandler(a,{discounts:[h.discountId]});break;case"closeSelectEntityCard":r.closeSelectEntityCardHandler();break;case"openSelectDiscountCard":r.getDiscountsListHandler();break;case"closeSelectDiscountCard":r.closeSelectDiscountCardHandler();break;case"manageCustomer":r.manageCustomerHandler(h);break;case"createCustomer":r.createCustomerHandler(h);break;case"updateCustomer":r.updateCustomerHandler(h);break;case"deleteCustomer":r.deleteCustomerHandler(h);break;case"closeCustomerCard":r.closeCustomerCardHandler();break}}return t.jsx("div",{className:De.ordersPage,children:t.jsxs(Oe,{menuCollectionType:"order",menuTitle:"Order",itemId:Number(a),counter:e.productCounter,activeCards:n.activeCards,children:[t.jsx(Ue,{isLoading:n.isOrderConfigurationCardLoading,isDiscountsGridLoading:n.isDiscountsGridLoading,isShipmentsGridLoading:n.isShipmentsGridLoading,order:e.selectedOrder,onAction:p}),((l=n.activeCards)==null?void 0:l.includes("selectEntityCard"))&&t.jsx("div",{ref:s("selectEntityCard"),children:t.jsx(be,{isLoading:n.isSelectEntityCardLoading,isGridLoading:n.isSelectEntityGridLoading,entityName:"Customer",entityCollection:e.customersGridRequestModel.items,columns:Te({onAction:p}),onAction:p})}),((f=n.activeCards)==null?void 0:f.includes("customerCard"))&&t.jsx("div",{ref:s("customerCard"),children:t.jsx(Ie,{isLoading:n.isCustomerCardLoading,showCloseButton:!0,customer:n.selectedCustomer,onAction:p})}),((j=n.activeCards)==null?void 0:j.includes("selectDiscountCard"))&&t.jsx("div",{ref:s("selectDiscountCard"),children:t.jsx(st,{isLoading:n.isSelectDiscountCardLoading,isGridLoading:n.isSelectDiscountGridLoading,discounts:n.discountsList,onAction:p})})]})})}export{bt as OrderDetailsPage};
