import{j as r,o as rn,t as ee,k as _,ao as an,B as ne,m as k,ah as tn,I as sn,z as H,L as on,Q as ln,c as cn,H as dn,a as G,S as D,V as M,bH as s,l as gn,a4 as un,a3 as mn,E as pn,r as R}from"./index-CqLEDb0h.js";import{G as fn,a as hn}from"./GridSortingEnum-Qa64oiYF.js";import{S as O}from"./SheCard-CX5qtFRW.js";import{o as w,s as Cn,c as U,b,u as re,S as ae,a as P}from"./types-TQ-jcydJ.js";import{a as Q,b as q,S as Mn}from"./SheSelect-C_zn2LY0.js";import{R as te,S as T}from"./SheInput-DbpOA7IC.js";import{u as ie,I as In}from"./useAppTranslation-CsMEigHw.js";import{H as se,J as xn,K as yn,S as Fn}from"./SheContextSidebar-CL4FXvtg.js";import{P as Pn}from"./plus-Cg_Vlo1I.js";import{T as _n,C as V}from"./SheCardNotification-BVOYMQJ2.js";import{G as J}from"./GridItemsFilter-C9zRYV-7.js";import{G as Y}from"./GridTraitsFilter-CP_O8I3b.js";import{S as Sn}from"./SheGrid-Fci2HgNW.js";import{c as vn}from"./she-select-convertors-CdG-Ygpu.js";import{S as jn}from"./SelectEntityCard-CxCADFZ_.js";import{u as Tn}from"./useProductsPageService-TLcc9QQg.js";import{u as bn}from"./useToast-BWT7QgMZ.js";import{u as Nn}from"./useCardActions-BvZqcpJ7.js";import"./ComponentViewEnum-Ba6F4129.js";import"./form-BPwqqXcv.js";import"./select-DL5f33uf.js";import"./chevron-up-DLJ1s3UP.js";import"./settings-2-BKZv0M77.js";import"./folder-up-D4AQ9V_0.js";import"./trash-Czml7Fyd.js";const Ln="_marginPage_1buxd_1",kn="_salePriceManagementCard_1buxd_1",X={marginPage:Ln,salePriceManagementCard:kn},Hn="_marginForPurchaseCard_13z9v_1",Dn="_marginForPurchaseCardContent_13z9v_1",An="_electedMarginBlock_13z9v_1",Bn="_marginDetails_13z9v_7",Gn="_marginActions_13z9v_12",Rn="_marginActionsTitleBlock_13z9v_18",En="_marginIsDeletedTitle_13z9v_22",zn="_marginActionsButtonBlock_13z9v_25",$n="_marginIsDeletedBlock_13z9v_29",F={marginForPurchaseCard:Hn,marginForPurchaseCardContent:Dn,electedMarginBlock:An,marginDetails:Bn,marginActions:Gn,marginActionsTitleBlock:Rn,marginIsDeletedTitle:En,marginActionsButtonBlock:zn,marginIsDeletedBlock:$n},wn="_marginConfiguration_1m4iu_1",Vn="_marginConfigurationForm_1m4iu_1",On="_formFooterOneButton_1m4iu_5",Wn="_formFooterTwoButton_1m4iu_8",Kn="_marginConfigurationTitle_1m4iu_11",Un="_marginConfigurationText_1m4iu_15",Qn="_marginConfigurationFormItem_1m4iu_21",qn="_percentInputBlock_1m4iu_25",Jn="_percentInputSymbol_1m4iu_29",Yn="_percentInput_1m4iu_25",h={marginConfiguration:wn,marginConfigurationForm:Vn,formFooterOneButton:On,formFooterTwoButton:Wn,marginConfigurationTitle:Kn,marginConfigurationText:Un,marginConfigurationFormItem:Qn,percentInputBlock:qn,percentInputSymbol:Jn,percentInput:Yn},Xn="field is required",Zn=w({marginName:Cn().nonempty(Xn).min(2,"min value length 2"),marginRule:w({desiredProfit:b().optional(),plannedDiscount:b().optional(),fixedCosts:b().optional(),roundTo:U().optional(),nearest9:U().optional()})}),er={desiredProfit:null,plannedDiscount:null,fixedCosts:null,roundTo:!1,nearest9:!1},Z={marginName:null,marginRule:{...er}};function oe({className:u,data:e,isConfigurationCard:c=!0,onSubmit:n,onCancel:o}){const{form:p}=re({values:e,defaultValues:Z,scheme:Zn,mode:te.CHANGE});return r.jsx("div",{className:`${h.marginConfiguration} ${u}`,children:r.jsxs(ae,{className:h.marginConfigurationForm,form:p,defaultValues:Z,formPosition:rn.CENTER,fullWidth:!0,hideSecondaryBtn:!c,primaryBtnProps:{value:e?"Save Changes":"Create Margin",bgColor:"#007AFF"},footerClassName:c?h.formFooterTwoButton:h.formFooterOneButton,onSubmit:n,onCancel:o,children:[c&&r.jsxs(r.Fragment,{children:[r.jsx("span",{className:`${h.marginConfigurationText} she-text`,children:"This configuration allows you to automatically calculate the target prices based on conditions you set up and the product purchase price"}),r.jsx(P,{name:"marginName",className:h.marginConfigurationFormItem,render:({field:l})=>r.jsx(T,{label:"Margin Name",value:l.value,fullWidth:!0,placeholder:"Enter margin name..."})}),r.jsx(ee,{})]}),r.jsx("span",{className:`${h.marginConfigurationTitle} she-title`,children:c?"Configure Margin Details":"Adjust margin details for this purchase"}),r.jsx(P,{name:"marginRule.desiredProfit",label:"Desired profit (in %)",className:h.marginConfigurationFormItem,render:({field:l})=>r.jsxs("div",{className:h.percentInputBlock,children:[r.jsx("span",{className:`${h.percentInputSymbol} she-text`,children:"%"}),r.jsx(T,{className:h.percentInput,placeholder:"Enter profit...",value:l.value,type:"text",fullWidth:!0,inputMode:"decimal",onBeforeInput:i=>{const g=i.nativeEvent.data??"";/[0-9.,]/.test(g)||i.preventDefault()},onChange:i=>{const g=typeof i=="string"?i.replace(",","."):i;l.onChange(g)}})]})}),r.jsx("span",{className:`${h.marginConfigurationText} she-subtext`,children:"The profit is calculated based on the purchase price, other percentages do not intersect with it, but they result in single total"}),r.jsx(P,{name:"marginRule.plannedDiscount",label:"Planned discount (in %)",className:h.marginConfigurationFormItem,render:({field:l})=>r.jsxs("div",{className:h.percentInputBlock,children:[r.jsx("span",{className:`${h.percentInputSymbol} she-text`,children:"%"}),r.jsx(T,{className:h.percentInput,placeholder:"Enter planned discount...",value:l.value,type:"text",fullWidth:!0,inputMode:"decimal",onBeforeInput:i=>{const g=i.nativeEvent.data??"";/[0-9.,]/.test(g)||i.preventDefault()},onChange:i=>{const g=typeof i=="string"?i.replace(",","."):i;l.onChange(g)}})]})}),r.jsx("span",{className:`${h.marginConfigurationText} she-subtext`,children:"Planned discount is the part of the price you are planning to eventually reduce. For example, you can add 20 pln to the price of an item, so later, you could reduce the price automatically up to this amount. If you don’t want to budget for discount, just leave the field empty."}),r.jsx(P,{name:"marginRule.fixedCosts",className:h.marginConfigurationFormItem,render:({field:l})=>r.jsx(T,{label:"Fixed costs (in PLN)",value:l.value,fullWidth:!0,placeholder:"Netto price",type:"number"})}),r.jsx("span",{className:`${h.marginConfigurationText} she-subtext`,children:"If you have fixed costs associated with every single purchase, this is a place to add them in. The fixed costs are for example cost of package, or fraction of the shipping fee. If you don’t want to count that in, leave the field empty."}),r.jsx(P,{name:"marginRule.roundTo",render:({field:l})=>r.jsx(Q,{text:"Round Brutto price to full number",description:"(This configuration rounds up all cents to full number)",type:q.SWITCH,checked:l.value})}),r.jsx(P,{name:"marginRule.nearest9",render:({field:l})=>r.jsx(Q,{text:"Jump the price to nearest 9",description:"(This configuration changes the last digit of the price to nearest 9. For example 61 will become 59, but 39 will become 39)",type:q.SWITCH,checked:l.value})})]})})}function nr({isLoading:u,margin:e,onAction:c}){var o;const{translate:n}=ie();return r.jsx(O,{className:F.marginForPurchaseCard,title:"Margin For Purchase",titleTransKey:"CardTitles.MarginForPurchase",isLoading:u,children:r.jsxs("div",{className:F.marginForPurchaseCardContent,children:[r.jsxs("div",{className:F.electedMarginBlock,children:[r.jsx("span",{className:"she-text",children:n("MarginForm.Labels.SelectMarginForPurchase")}),r.jsx(_,{value:"Select Margin",valueTransKey:"MarginActions.SelectMargin",icon:an,variant:"secondary",onClick:()=>c("openSelectMarginCard")})]}),e&&r.jsxs("div",{className:F.marginDetails,children:[r.jsxs("div",{className:F.marginActions,children:[r.jsx("div",{className:F.marginActionsTitleBlock,children:r.jsx("span",{className:`${e.isDeleted?F.marginIsDeletedTitle:""} she-title`,children:e.marginName})}),r.jsxs("div",{className:F.marginActionsButtonBlock,children:[((o=e==null?void 0:e.marginRule)==null?void 0:o.modified)&&r.jsx(_,{icon:se,txtColor:"#fff",bgColor:"#007AFF",onClick:()=>c("restoreMarginRules",e.marginId)}),r.jsx(_,{value:"Manage",valueTransKey:"ProductActions.Manage",icon:ne,variant:"secondary",onClick:()=>c("manageMargin",e)})]})]}),e.isDeleted&&r.jsx("div",{className:F.marginIsDeletedBlock,children:r.jsx("span",{className:"she-text",children:n("MarginMessages.MarginIsDeleted")})}),r.jsx(ee,{}),r.jsx(oe,{data:e,isConfigurationCard:!1,onSubmit:p=>c("updateSelectedMargin",p)})]})]})})}const rr="_marginConfigurationCard_1lpz0_1",ar="_marginConfigurationCardContent_1lpz0_1",tr="_marginConfigurationCardForm_1lpz0_7",E={marginConfigurationCard:rr,marginConfigurationCardContent:ar,marginConfigurationCardForm:tr};function ir({isLoading:u,margin:e,onAction:c}){return r.jsx(O,{className:E.marginConfigurationCard,title:e?"Manage Margin":"Create Margin",titleTransKey:e?"CardTitles.ManageMargin":"CardTitles.CreateMargin",showCloseButton:!0,isLoading:u,showNotificationCard:e,notificationCardProps:{title:e!=null&&e.isDeleted?"RestoreMargin":"Delete Margin",titleTransKey:e!=null&&e.isDeleted?"CardTitles.RestoreMargin":"CardTitles.DeleteMargin",text:e!=null&&e.isDeleted?"The margin was deleted and is no longer manageable.":"This margin will be deleted and will no longer be available for selection or automatic connection",textTransKey:e!=null&&e.isDeleted?"ConfirmationMessages.RestoreMargin":"ConfirmationMessages.DeleteMargin",buttonText:e!=null&&e.isDeleted?"Restore":"Delete",buttonTextTransKey:e!=null&&e.isDeleted?"CommonButtons.Restore":"CommonButtons.Delete",buttonColor:e!=null&&e.isDeleted?"#38BF5E":"#EF4343",buttonIcon:e!=null&&e.isDeleted?Pn:_n,onClick:()=>e!=null&&e.isDeleted?c("restoreMargin",e):c("deleteMargin",e)},onSecondaryButtonClick:()=>c("closeMarginConfigurationCard"),children:r.jsx("div",{className:E.marginConfigurationCardContent,children:r.jsx(oe,{className:E.marginConfigurationCardForm,data:e,onSubmit:n=>c(e?"updateMargin":"createMargin",n),onCancel:()=>c("closeMarginConfigurationCard")})})})}const sr="_salePriceManagementCard_1pmum_1",or="_salePriceManagementCardContent_1pmum_4",lr="_buttonBlock_1pmum_9",z={salePriceManagementCard:sr,salePriceManagementCardContent:or,buttonBlock:lr},cr="_productName_tldvw_10",dr="_productCode_tldvw_20",gr="_marginItemsForm_tldvw_29",$={productName:cr,productCode:dr,marginItemsForm:gr},ur="_marginItemsFormWrapper_152jo_1",mr="_marginItemsForm_152jo_1",pr="_marginItemsFormItem_152jo_8",fr="_inputChanged_152jo_12",hr="_selectChanged_152jo_15",Cr="_marginItemsFormText_152jo_18",Mr="_marginItemsFormInput_152jo_22",Ir="_marginItemsFormIcon_152jo_26",xr="_arrowIcon_152jo_34",yr="_arrowIconActive_152jo_41",Fr="_lockIcon_152jo_44",Pr="_undoIcon_152jo_48",_r="_undoIconActive_152jo_53",Sr="_formButtonNotActive_152jo_57",m={marginItemsFormWrapper:ur,marginItemsForm:mr,marginItemsFormItem:pr,inputChanged:fr,selectChanged:hr,marginItemsFormText:Cr,marginItemsFormInput:Mr,marginItemsFormIcon:Ir,arrowIcon:xr,arrowIconActive:yr,lockIcon:Fr,undoIcon:Pr,undoIconActive:_r,formButtonNotActive:Sr},vr=w({marginPrice:b().optional(),taxTypeId:b().optional()}),jr={marginItemId:null,stockActionId:null,variantId:null,thumbnailUrl:"",productId:null,variantCode:"",variantName:"",traitOptions:[],purchasePrice:"",currentPrice:null,taxTypeId:null,marginPrice:null,unitsAmount:null,taxTypeChanged:!1,marginPriceChanged:!1,taxChangesNotApplied:!1,locked:!1,isChanged:!1,marginPriceApplied:!1};function Tr({className:u="",data:e,taxes:c,onMarginItemChange:n,onApply:o}){const{form:p}=re({values:e,defaultValues:jr,scheme:vr,mode:te.SUBMIT});return r.jsx("div",{className:`${u} ${m.marginItemsFormWrapper}`,children:r.jsxs(ae,{className:m.marginItemsForm,form:p,fullWidth:!0,hideFooter:!0,children:[r.jsx(P,{name:"taxTypeId",className:`${m.marginItemsFormItem} ${m.marginItemsFormInput}`,render:({field:l})=>r.jsx(Mn,{className:e!=null&&e.taxTypeChanged?m.selectChanged:"",placeholder:" ",selected:(l==null?void 0:l.value)||(e==null?void 0:e.taxTypeId),items:c,hideFirstOption:!0,minWidth:"70px",maxWidth:"70px",onSelect:()=>{n(p.getValues())}})}),r.jsx("div",{className:`${m.marginItemsFormItem} ${m.marginItemsFormIcon} ${e.taxTypeChanged?m.arrowIconActive:m.arrowIcon}`,children:r.jsx(k,{icon:xn,color:"#007AFF",onClick:()=>{n({...e,taxChangesNotApplied:!0})}})}),r.jsx(P,{name:"marginPrice",className:`${m.marginItemsFormItem} ${m.marginItemsFormInput}`,render:({field:l})=>r.jsx(T,{value:l.value,className:e!=null&&e.marginPriceChanged?m.inputChanged:"",minWidth:"70px",maxWidth:"70px",autoFocus:e.selectedItem,delayTime:1500,onDelay:()=>{n(p.getValues())}})}),r.jsx(k,{icon:yn,color:e.locked?"#007AFF":"#E4E4E7",className:`${m.marginItemsFormItem} ${m.marginItemsFormIcon} ${m.lockIcon}`,onClick:()=>n({...e,locked:!(e!=null&&e.locked)})}),r.jsx(k,{icon:se,color:e.isChanged?"#EF4343":"#E4E4E7",className:`${m.marginItemsFormItem} ${m.marginItemsFormIcon} ${e.isChanged?m.undoIconActive:m.undoIcon}`,onClick:()=>n({...e,isChanged:!1})}),r.jsxs("span",{className:`${m.marginItemsFormText} she-text`,children:[e.unitsAmount," ",e.unitsAmount===1?"unit":"units"]}),r.jsx(_,{className:e!=null&&e.marginPriceApplied?m.formButtonNotActive:"",value:e!=null&&e.marginPriceApplied?"Applied":"Apply",icon:e!=null&&e.marginPriceApplied?V:tn,txtColor:e!=null&&e.marginPriceApplied?"#38BF5E":"",variant:e!=null&&e.marginPriceApplied?"ghost":"secondary",onClick:()=>o(e==null?void 0:e.marginItemId)})]})})}function br(u,e){return[{accessorKey:"thumbnailUrl",header:"Image",minSize:56,maxSize:56,cell:({row:c})=>{const n=c.getValue("thumbnailUrl");return r.jsx(k,{icon:n||In,className:"m-auto",style:{...!n&&{padding:"10px"}},color:"#64748b",iconView:sn.BUTTON})}},{accessorKey:"variantCode",header:"Code",minSize:60,maxSize:150,cell:({row:c})=>r.jsx(H,{delayDuration:200,text:c.getValue("variantCode"),children:r.jsx("span",{className:$.productCode,children:c.getValue("variantCode")})})},{accessorKey:"variantName",header:"Product Name",minSize:100,cell:({row:c})=>r.jsx(H,{delayDuration:200,text:c.getValue("variantName"),children:r.jsx("span",{className:$.productName,children:c.getValue("variantName")})})},{accessorKey:"traitOptions",header:"Details",minSize:80,maxSize:200,cell:({row:c})=>{const n=c.original.traitOptions||[],o=n.filter(l=>l.traitTypeId===2&&l.optionColor),p=n.filter(l=>l.traitTypeId===1&&l.optionName);return r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",maxWidth:"50px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",verticalAlign:"middle"},children:[o.map((l,i)=>r.jsx("div",{style:{background:l.optionColor,minWidth:"20px",minHeight:"20px",borderRadius:"50%",border:"2px solid #ccc"}},`color-${i}`)),p.map((l,i)=>r.jsx("span",{style:{fontSize:"0.875rem"},children:l.optionName},`size-${i}`))]})}},{accessorKey:"purchasePrice",header:"Purchase Price",minSize:120,maxSize:200,enableHiding:!1,cell:({row:c})=>r.jsx("span",{children:c.getValue("purchasePrice")})},{accessorKey:"currentPrice",header:()=>r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",maxWidth:"80px"},children:[r.jsx("span",{style:{textWrap:"wrap"},children:"Current Price"}),r.jsx(H,{showDefaultIcon:!0})]}),minSize:100,maxSize:200,enableHiding:!1,cell:({row:c})=>r.jsx("span",{children:c.getValue("currentPrice")})},{id:"form",accessorKey:"",minSize:460,maxSize:460,enableHiding:!1,header:()=>r.jsxs("div",{className:"flex items-center",children:[r.jsx("span",{style:{marginLeft:"3px",marginRight:"92px"},children:"Tax"}),r.jsx("span",{style:{marginRight:"84px"},children:"Margin Price"}),r.jsx("span",{children:"Quantity"})]}),cell:({row:c})=>r.jsx(Tr,{className:$.marginItemsForm,data:c.original,taxes:vn(u,{text:"name",value:"id"}),currentPrice:c.getValue("currentPrice"),onMarginItemChange:n=>{e("updateMarginItem",n)},onApply:n=>e("applyMarginItem",n)})}]}function Nr({isLoading:u,isGridLoading:e,preferences:c,sortingOptions:n,brands:o,categories:p,colors:l,sizes:i,taxes:g,gridRequestModel:C,onAction:I}){var v,j;const{translate:S}=ie();return r.jsxs("div",{className:z.salePriceManagementCard,children:[r.jsx(O,{className:z.salePriceManagementCardContent,title:"Sale Price Management",titleTransKey:"CardTitles.SalePriceManagement",isLoading:u,children:r.jsxs(Sn,{isLoading:e,columns:br(g,I),data:C==null?void 0:C.items,sortingItems:n,columnsPreferences:c,gridRequestModel:C,preferenceContext:"salePriceManagementReferences",skeletonQuantity:C==null?void 0:C.pageSize,onApplyColumns:f=>I("applyColumns",f),onDefaultColumns:()=>I("resetColumns"),onGridRequestChange:f=>I("gridRequestChange",f),children:[r.jsx(J,{items:o,columnName:S("SectionTitles.Brand"),getId:f=>f.brandId,getName:f=>f.brandName,selected:(v=C==null?void 0:C.filter)==null?void 0:v.brands}),r.jsx(J,{items:p,columnName:S("SectionTitles.Category"),getId:f=>f.categoryId,getName:f=>f.categoryName,selected:(j=C==null?void 0:C.filter)==null?void 0:j.categories}),r.jsx(Y,{traitOptions:l,traitType:"color"}),r.jsx(Y,{traitOptions:i,traitType:"size"})]})}),r.jsxs("div",{className:z.buttonBlock,children:[r.jsx(_,{value:"Apply visible prices",valueTransKey:"SpecialText.ApplyVisiblePrices",icon:V,variant:"info",onClick:()=>I("applyVisibleMarginItems")}),r.jsx(_,{value:"Apply all prices",valueTransKey:"SpecialText.ApplyAllPrices",icon:V,variant:"info",onClick:()=>I("applyAllMarginItems")})]})]})}const Lr="_iconCheck_1wa1s_1",kr={iconCheck:Lr};function Hr({onAction:u}){return[{id:"select",header:"Select",minSize:70,maxSize:70,cell:({row:e,table:c})=>{const n=c.options.meta,o=p=>{p.stopPropagation(),p.preventDefault(),u("selectMargin",e.original)};return r.jsx("div",{onClick:p=>p.stopPropagation(),children:r.jsx(_,{className:e.original.isSelected===!0?kr.iconCheck:"",icon:e.original.isSelected===!0?on:ln,variant:"ghost",onClick:o,disabled:n==null?void 0:n.isRowLoading(e.id)})})}},{id:"marginName",header:"Margin name",minSize:150,cell:({row:e})=>r.jsx(H,{delayDuration:200,text:e.original.marginName,className:"max-w-[100%] overflow-hidden text-ellipsis whitespace-nowrap",children:r.jsx("span",{className:"she-text",children:e.original.marginName})})},{id:"manage",header:"Actions",minSize:120,maxSize:120,cell:({row:e,table:c})=>{const n=c.options.meta;return r.jsx("div",{onClick:o=>o.stopPropagation(),children:r.jsx(_,{icon:ne,value:"Manage",variant:"secondary",onClick:()=>u("manageMargin",e.original),disabled:n==null?void 0:n.isRowLoading(e.id)})})}}]}function Dr(u,e,c){const n=cn(),{addToast:o}=bn(),{openConfirmationDialog:p}=dn(),l=Tn(),i=G(D.MARGINS),g=G(D.PRODUCTS),C=G(D.APP),[I]=M.useGetMarginsListForGridMutation(),[S]=M.useGetMarginItemsListForGridMutation(),[v]=M.useLazyGetAllMarginsQuery(),[j]=M.useLazyGetMarginForPurchaseQuery(),[f]=M.useLazyGetMarginDetailsQuery(),[x]=M.useCreateMarginMutation(),[le]=M.useUpdateMarginMutation(),[ce]=M.useCreateMarginRulesMutation(),[de]=M.useDeleteMarginMutation(),[ge]=M.useRestoreMarginMutation(),[ue]=M.useConnectMarginToPurchaseMutation(),[me]=M.useDetachMarginMutation(),[pe]=M.useRestoreMarginRuleToDefaultMutation(),[Ar]=M.useUpdateMarginItemMutation(),[fe]=M.useApplyMarginItemMutation(),[he]=M.useUpdateMarginRulesForPurchaseMutation(),[Ce]=M.useApplyVisibleMarginItemsMutation(),[Me]=M.useApplyAllMarginItemsMutation();function N(t){return I(t).then(a=>(n(s.refreshMarginsList(a.data.items)),a.data))}function W(t,a){return S({purchaseId:t,model:a}).then(d=>(n(s.refreshMarginItemsGridRequestModel(d.data)),d.data))}function Ie(){return v().then(t=>(n(s.refreshMarginsList(t.data)),t.data))}function A(t){return j(t).then(a=>a.data)}function xe(t){return f(t).then(a=>a.data)}function ye(t){return x(t).then(a=>a.data)}function Fe(t,a){return le({marginId:t,model:a}).then(d=>d.data)}function K(t,a){return ce({marginId:t,model:a}).then(d=>d.data)}function Pe(t){return de(t).then(a=>a)}function _e(t){return ge(t).then(a=>a)}function Se(t,a){return ue({purchaseId:t,marginId:a}).then(d=>d.data)}function ve(t){return me(t).then(a=>a.data)}function je(t){return pe(t).then(a=>a.data)}function Te(t){return fe(t).then(a=>a.data)}function be(t,a){return he({purchaseId:t,model:a}).then(d=>d.data)}function Ne(t,a){return Ce({purchaseId:t,model:a}).then(d=>d.data)}function Le(t){return Me(t).then(a=>a.data)}function ke(t,a){W(t,a)}function He(){e({selectEntityCard:!0,salePriceManagementCard:!1}),n(s.setIsSelectMarginCardLoading(!0)),N(i.marginsGridRequestModel).then(t=>{n(s.setIsSelectMarginCardLoading(!1)),n(s.setIsMarginListGridLoading(!1));const a=t.items.map(d=>({...d,isSelected:d.marginId===i.selectedMargin.marginId}));n(s.refreshMarginsList(a))})}function De(t){n(s.setIsMarginListGridLoading(!0)),N({...i.marginsGridRequestModel,searchQuery:t}).then(a=>{n(s.setIsMarginListGridLoading(!1));const d=a.items.map(y=>({...y,isSelected:y.marginId===i.selectedMargin.marginId}));n(s.refreshMarginsList(d))})}function Ae(t,a){n(s.setIsMarginForPurchaseCardLoading(!0)),Se(a,t.marginId).then(d=>{n(s.setIsMarginForPurchaseCardLoading(!1)),u("selectEntityCard"),d?(n(s.refreshActiveCards(null)),n(s.refreshSelectedMargin(d)),B(a),o({text:"Margin selected successfully",type:"success"})):o({text:`${d.error.data.detail}`,type:"error"})})}function Be(t){n(s.setIsMarginForPurchaseCardLoading(!0)),ve(t).then(a=>{n(s.setIsMarginForPurchaseCardLoading(!1)),a.error?o({text:`${a.error.data.detail}`,type:"error"}):(n(s.resetSelectedMargin()),o({text:"Margin detached successfully",type:"success"}))})}function Ge(t){n(s.setIsMarginConfigurationCardLoading(!0)),ye({marginName:t.marginName}).then(a=>{a?(K(a.marginId,t.marginRule).then(()=>{n(s.setIsMarginConfigurationCardLoading(!1)),n(s.setIsMarginListGridLoading(!0)),n(s.setIsSelectMarginCardLoading(!0)),N(i.marginsGridRequestModel).then(d=>{n(s.setIsSelectMarginCardLoading(!1)),n(s.setIsMarginListGridLoading(!1));const y=d.items.map(L=>({...L,isSelected:L.marginId===i.selectedMargin.marginId}));n(s.refreshMarginsList(y))})}),u("marginConfigurationCard"),o({text:"Margin created successfully",type:"success"})):o({text:`${a.error.data.detail}`,type:"error"})})}function Re(t){n(s.setIsMarginConfigurationCardLoading(!0)),Promise.all([Fe(i.managedMargin.marginId,{marginName:t.marginName}),K(i.managedMargin.marginId,t.marginRule)]).then(([a,d])=>{n(s.setIsMarginConfigurationCardLoading(!1)),a.marginName!==i.managedMargin.marginName&&(n(s.setIsSelectMarginCardLoading(!0)),N(i.marginsGridRequestModel).then(()=>{n(s.setIsSelectMarginCardLoading(!1))})),a&&d?(u("marginConfigurationCard"),o({text:"Default margin has been updated",type:"success"})):o({text:`${a.error.data.detail||d.error.data.detail}`,type:"error"})})}function Ee(t,a){n(s.setIsMarginForPurchaseCardLoading(!0)),be(a,t.marginRule).then(d=>{n(s.setIsMarginForPurchaseCardLoading(!1)),d.error?o({text:`${d.error.data.detail}`,type:"error"}):(n(s.refreshSelectedMargin({...i.selectedMargin,marginRule:d})),B(a),o({text:"Margin updated successfully",type:"success"}))})}function ze(t){e({marginConfigurationCard:!0,salePriceManagementCard:!1}),n(s.setIsMarginConfigurationCardLoading(!0)),xe(t.marginId).then(a=>{n(s.setIsMarginConfigurationCardLoading(!1)),a?(n(s.refreshManagedMargin(a)),n(s.refreshMarginsList(mn(t.marginId,i.marginsList,"marginId")))):u("marginConfigurationCard")})}async function $e(t,a){await p({headerTitle:"Deleting margin rule",text:"You are about to delete the margin rule. The prices that were previously calculated using this margin, will remain intact. The margin will no longer be applied to new purchases.",primaryButtonValue:"Delete",secondaryButtonValue:"Cancel"})&&Pe(t.marginId).then(y=>{y.error?o({text:y.error.data.detail,type:"error"}):(n(s.refreshManagedMargin({...i.managedMargin,isDeleted:!0})),i.selectedMargin.marginId===t.marginId&&(n(s.setIsMarginForPurchaseCardLoading(!0)),A(a).then(L=>{n(s.setIsMarginForPurchaseCardLoading(!1)),n(s.refreshSelectedMargin(L))})),o({text:"Margin deleted successfully",type:"success"}))})}function we(t,a){n(s.setIsMarginConfigurationCardLoading(!0)),_e(t.marginId).then(d=>{n(s.setIsMarginConfigurationCardLoading(!1)),d.error?o({text:d.error.data.detail,type:"error"}):(n(s.refreshManagedMargin({...i.managedMargin,isDeleted:!1})),i.selectedMargin.marginId===t.marginId&&(n(s.setIsMarginForPurchaseCardLoading(!0)),A(a).then(y=>{n(s.setIsMarginForPurchaseCardLoading(!1)),n(s.refreshSelectedMargin(y))})),o({text:"Margin restored successfully",type:"success"}))})}function Ve(t){n(s.setIsMarginForPurchaseCardLoading(!0)),je(t).then(a=>{n(s.setIsMarginForPurchaseCardLoading(!1)),a.error?o({text:a.error.data.detail,type:"error"}):(n(s.refreshSelectedMargin(a)),o({text:"Margin restored successfully",type:"success"}))})}function Oe(t){const a=i.marginItemsGridRequestModel.items.map(d=>d.marginItemId===t.marginItemId?{...t,selectedItem:!0}:{...d,selectedItem:!1});n(s.refreshMarginItemsGridRequestModel({...i.marginItemsGridRequestModel,items:a}))}function We(t){Te(t).then(a=>{if(a){const d=i.marginItemsGridRequestModel.items.map(y=>y.marginItemId===a.marginItemId?a:y);n(s.refreshMarginItemsGridRequestModel({...i.marginItemsGridRequestModel,items:d}))}else o({text:a.error.data.detail,type:"error"})})}function Ke(t){n(s.setIsMarginProductsGridLoading(!0)),Ne(t,i.marginItemsGridRequestModel).then(a=>{n(s.setIsMarginProductsGridLoading(!1)),a?(n(s.refreshMarginItemsGridRequestModel(a)),o({text:"Visible margin items applied successfully",type:"success"})):o({text:a.error.data.detail,type:"error"})})}function Ue(t){n(s.setIsMarginProductsGridLoading(!0)),Le(t).then(a=>{n(s.setIsMarginProductsGridLoading(!1)),a?(n(s.refreshMarginItemsGridRequestModel(a)),o({text:"All margin items applied successfully",type:"success"})):o({text:a.error.data.detail,type:"error"})})}function Qe(){n(s.resetManagedMargin()),u("marginConfigurationCard",!0)}function qe(){u("selectEntityCard")}function Je(){u("selectMarginCard")}function Ye(){u("marginConfigurationCard")}function Xe(t){const a=gn.merge({},C.preferences,t);n(un.refreshPreferences(a)),l.updateUserPreferencesHandler(a)}function Ze(){l.resetUserPreferencesHandler("salePriceManagement")}function en(t){n(s.resetSelectedMargin()),n(s.setIsMarginForPurchaseCardLoading(!0)),A(t).then(a=>{n(s.setIsMarginForPurchaseCardLoading(!1)),n(s.refreshSelectedMargin(a))}),g.purchaseCounters||(n(s.setIsProductMenuCardLoading(!0)),l.getPurchaseCountersHandler(Number(t)).then(()=>n(s.setIsProductMenuCardLoading(!1)))),i.marginsList.length===0&&Ie(),g.taxesList.length===0&&l.getTaxesListHandler(),g.brands.length===0&&l.getBrandsForFilterHandler(),g.categories.length===0&&l.getCategoriesForFilterHandler(),(g.sizesForFilter.length===0||g.colorsForFilter.length===0)&&l.getTraitsForFilterHandler(),c(["salePriceManagementCard"])}function B(t){n(s.setIsMarginProductsGridLoading(!0)),W(t,i.marginItemsGridRequestModel).then(()=>{n(s.setIsMarginProductsGridLoading(!1))})}function nn(){i.activeCards.length===0&&u("salePriceManagementCard",!0)}return{state:i,appState:C,productsState:g,gridRequestChangeHandle:ke,openSelectMarginCardHandle:He,searchEntityHandle:De,selectMarginHandle:Ae,detachMarginHandle:Be,createMarginHandle:Ge,updateMarginHandle:Re,updateSelectedMarginHandler:Ee,manageMarginHandle:ze,deleteMarginHandle:$e,restoreMarginHandle:we,restoreMarginRulesHandle:Ve,updateMarginItemHandle:Oe,applyMarginItemItemHandle:We,openCreateEntityCardHandle:Qe,closeSelectEntityCardHandle:qe,closeSelectMarginCardHandle:Je,closeMarginConfigurationCardHandle:Ye,applyColumnsHandle:Xe,resetColumnsHandle:Ze,applyVisibleMarginItemsHandle:Ke,applyAllMarginItemsHandle:Ue,getMarginPageDataHandle:en,getMarginItemsListHandle:B,keepSalePriceManagementCardOpenHandle:nn}}function oa(){var S,v,j;const{handleCardAction:u,handleMultipleCardActions:e,keepOnlyCards:c,createRefCallback:n}=Nn({selectActiveCards:f=>f[D.MARGINS].activeCards,refreshAction:s.refreshActiveCards}),{state:o,appState:p,productsState:l,...i}=Dr(u,e,c),{purchaseId:g}=pn(),C=Object.values(fn).map(f=>({value:f,description:hn[f]}));R.useEffect(()=>{i.getMarginPageDataHandle(g)},[g]),R.useEffect(()=>{i.getMarginItemsListHandle(g)},[]),R.useEffect(()=>{i.keepSalePriceManagementCardOpenHandle()},[o.activeCards]);async function I(f,x){switch(f){case"openSelectMarginCard":i.openSelectMarginCardHandle();break;case"searchEntity":i.searchEntityHandle(x);break;case"selectMargin":i.selectMarginHandle(x,g);break;case"detachMargin":i.detachMarginHandle(g);break;case"createMargin":i.createMarginHandle(x);break;case"updateMargin":i.updateMarginHandle(x);break;case"updateSelectedMargin":i.updateSelectedMarginHandler(x,g);break;case"manageMargin":i.manageMarginHandle(x);break;case"deleteMargin":i.deleteMarginHandle(x,g);break;case"restoreMargin":i.restoreMarginHandle(x,g);break;case"restoreMarginRules":i.restoreMarginRulesHandle(g);break;case"updateMarginItem":i.updateMarginItemHandle(x);break;case"applyMarginItem":i.applyMarginItemItemHandle(x);break;case"openCreateEntityCard":i.openCreateEntityCardHandle();break;case"closeSelectEntityCard":i.closeSelectEntityCardHandle();break;case"closeSelectMarginCard":i.closeSelectMarginCardHandle();break;case"closeMarginConfigurationCard":i.closeMarginConfigurationCardHandle();break;case"applyColumns":i.applyColumnsHandle(x);break;case"resetColumns":i.resetColumnsHandle();break;case"gridRequestChange":i.gridRequestChangeHandle(g,x);break;case"applyVisibleMarginItems":i.applyVisibleMarginItemsHandle(g);break;case"applyAllMarginItems":i.applyAllMarginItemsHandle(g);break}}return r.jsx("div",{className:X.marginPage,children:r.jsxs(Fn,{menuCollectionType:"purchases",menuTitle:"Manage Product",itemId:Number(g),counter:l.purchaseCounters,activeCards:o.activeCards,children:[r.jsx(nr,{isLoading:o.isMarginForPurchaseCardLoading,margin:o.selectedMargin,onAction:I}),((S=o.activeCards)==null?void 0:S.includes("salePriceManagementCard"))&&r.jsx("div",{className:X.salePriceManagementCard,ref:n("salePriceManagementCard"),children:r.jsx(Nr,{isLoading:o.isSalePriceManagementCardLoading,isGridLoading:o.isMarginProductsGridLoading,preferences:p.preferences,brands:l.brands,categories:l.categories,sizes:l.sizesForFilter,colors:l.colorsForFilter,taxes:l.taxesList,sortingOptions:C,gridRequestModel:o.marginItemsGridRequestModel,onAction:I})}),((v=o.activeCards)==null?void 0:v.includes("selectEntityCard"))&&r.jsx("div",{ref:n("selectEntityCard"),children:r.jsx(jn,{isLoading:o.isSelectMarginCardLoading,isGridLoading:o.isMarginListGridLoading,entityName:"Margin",entityCollection:o.marginsList,columns:Hr({onAction:I}),onAction:I})}),((j=o.activeCards)==null?void 0:j.includes("marginConfigurationCard"))&&r.jsx("div",{ref:n("marginConfigurationCard"),children:r.jsx(ir,{isLoading:o.isMarginConfigurationCardLoading,margin:o.managedMargin,onAction:I})})]})})}export{oa as MarginsPage};
